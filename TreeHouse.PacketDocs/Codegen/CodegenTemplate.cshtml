@using System
@using System.Collections.Generic
@using System.Linq
@using RazorBlade
@using TreeHouse.Common
@using TreeHouse.PacketFormat

@namespace TreeHouse.PacketDocs.Codegen

@inherits PlainTextTemplate<PacketFormatDocument>

/// <auto-generated />

using TreeHouse.Common.IO;
using TreeHouse.PacketParser.Support;

namespace TreeHouse.PacketParser;

@functions
{
    public static string FormatId(byte id, byte subId)
    {
        uint ids = (uint)id | ((uint)subId << 8);
		return $"0x{ids:X4}";
    }

    public void RenderStructure(string name, StructureBuilder builder, string sizeEstimate)
    {
        @:  public partial struct @name : ISpanReadWrite
        @:  {
        @:      @builder.GetMembers()
        @:
        @:      public readonly int EstimateSize() => (int)(@sizeEstimate);
        @:
        @:      public void Read(SpanReader reader)
        @:      {
        @:          @builder.GetRead()
        @:      }
        @:
        @:      public readonly void Write(SpanWriter writer)
        @:      {
        @:          @builder.GetWrite()
        @:      }
        @:  }
    }
}

@{
    StructureSizeCollector sizeCollector = new StructureSizeCollector(x => {
        if (Model.Structures.TryGetValue(x, out FieldsList? structure))
            return structure;
        else if (Model.Packets.TryGetValue(x, out PacketDefinition? packet))
            return packet;
        throw new InvalidOperationException($"Structure {x} does not exist");
    });
}

@foreach (var item in Model.Structures)
{
    string name = StructureBuilder.ConvertTypeName(item.Key);
    StructureBuilder builder = new();
    builder.AppendFieldsList(item.Value);
    RenderStructure(name, builder, sizeCollector.GetSizeEstimate(item.Key).ToString());
}

@foreach (var item in Model.Packets)
{
    string className = StructureBuilder.ConvertTypeName(item.Key); 

    StructureBuilder builder = new();

    string? baseType = item.Value.Inherit;
    if (baseType != null)
    {
        builder.AppendField(new Field() {
            Name = $"Base{StructureBuilder.ConvertTypeName(baseType)}",
            Type = new PrimitiveFieldType() { Value = $":{baseType}" }
        });
    }

    builder.AppendFieldsList(item.Value);

    if (item.Value.Id == 0 && item.Value.SubId == 0)
    {
        RenderStructure(className, builder, sizeCollector.GetSizeEstimate(item.Key).ToString());
    }
    else
    {
        @:  public partial class @className : PacketBranch
        @:  {
        @:      @builder.GetMembers()
        @:
        @:      public @(className)()
        @:      {
        @:          PacketId = @(FormatId(item.Value.Id, item.Value.SubId));
        @:      }
        @:
        @:      public override int EstimateSize() => (int)(@(sizeCollector.GetSizeEstimate(item.Key)));
        @:
        @:      public override void Read(SpanReader reader)
        @:      {
        @:          @builder.GetRead()
        @:      }
        @:
        @:      public override void Write(SpanWriter writer)
        @:      {
        @:          @builder.GetWrite()
        @:      }
        @:  }
    }
}

public struct Packet : ISpanReadWrite
{
    private static readonly global::System.Collections.Generic.Dictionary<ushort, global::System.Func<PacketBranch>> idToPacketFactory = new()
    {
        @foreach (var item in Model.Packets.Where(x => !(x.Value.Id == 0 && x.Value.SubId == 0)))
        {
            @: { @FormatId(item.Value.Id, item.Value.SubId), () => new @(StructureBuilder.ConvertTypeName(item.Key))() },
        }
    };

    public PacketBranch Branch;

    public readonly int EstimateSize() => 2 + Branch.EstimateSize();

    public void Read(SpanReader reader)
    {
        ushort id = reader.ReadUInt16LE();
        Branch = idToPacketFactory[id]();
        Branch.Read(reader);
    }

    public readonly void Write(SpanWriter writer)
    {
        writer.WriteUInt16LE(Branch.PacketId);
        Branch.Write(writer);
    }
}

public abstract class PacketBranch : ISpanReadWrite
{
    public ushort PacketId { get; protected init; }

    public abstract void Read(SpanReader reader);

    public abstract int EstimateSize();

    public abstract void Write(SpanWriter writer);
}