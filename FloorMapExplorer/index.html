<!DOCTYPE html>
<html>
    <head>
        <title>TreeHouse FoorMap Explorer</title>
        <link
            rel="stylesheet" href="https://unpkg.com/leaflet@2.0.0-alpha.1/dist/leaflet.css"
            integrity="sha384-mduptj5Hiyp/jSH2p+p4A8UdSz0gnkrO1y37pdMuUTkAMEUuDsr12k7o4eQJXufp"
            crossorigin="anonymous"
        />
        <link rel="stylesheet" href="./leaflet-burgermenu/leaflet-burgermenu.css" />
        <script type="importmap">
            {
                "imports": {
                    "leaflet": "https://unpkg.com/leaflet@2.0.0-alpha.1/dist/leaflet.js",
                    "leaflet-burgermenu": "./leaflet-burgermenu/leaflet-burgermenu.js"
                },
                "integrity": {
                    "https://unpkg.com/leaflet@2.0.0-alpha.1/dist/leaflet.js": "sha384-h3ZIZ5xsHHscwk3hG7EdHHGZxzCzl9tFuX0xxQhH/gnJW82Ll5+qFXqq7XTiJKen"
                }
            }
        </script>
        <style>
        html, body, #map {
            height: 100%;
            margin: 0;
        }
        </style>
        <script type="module">
            import { Map, TileLayer, CRS, Projection, Transformation, Marker, Point } from "leaflet";
            import { BurgerMenuControl } from 'leaflet-burgermenu';

            function createCRS(info) {
                const tileCount = 1 << info.MaxZoom;
                const scale = 1 / info.UnitsPerPixel / tileCount;

                class ScaledSimple extends CRS.Simple {
                    static projection = Projection.LonLat;
                    static transformation = new Transformation(scale, -info.MinY * scale, -scale, info.TileHeight + (info.MinX * scale));
                    static infinite = true;
                }

                return ScaledSimple;
            }

            let map = new Map("map");

            const infoResponse = await fetch("data/MapInfo.json");
            const infoJson = await infoResponse.json();

            let menu = null;

            async function loadMap(packageName, zoneName) {
                const packageInfo = infoJson[packageName];
                if (packageInfo == undefined)
                    return;

                const info = packageInfo[zoneName];
                if (info == undefined)
                    return;

                const mapsPath = `data/maps/${packageName}/${zoneName}`;

                const crs = createCRS(info);

                map.remove();
                map = new Map("map", { crs: crs })

                menu.addTo(map);

                const imageMax = crs.pointToLatLng(new Point(info.TileWidth, 0), 0);

                new TileLayer(`${mapsPath}/{z}/{x}/{y}.png`, {
                    tileSize: [info.TileWidth, info.TileHeight],
                    bounds: [[info.MinX + 1, info.MinY + 1], [imageMax.lat - 1, imageMax.lng - 1]],
                    maxNativeZoom: info.MaxZoom,
                    maxZoom: info.MaxZoom + 2,
                    noWrap: true
                }).addTo(map);

                const centerX = (info.MinX + info.MaxX) / 2;
                const centerY = (info.MinY + info.MaxY) / 2;

                map.setView([centerX, centerY], 0);
            }

            const menuItems = Object.keys(infoJson).sort().map((packageName) => {
                const zones = infoJson[packageName];
                const nameTrimmed = packageName.replace("_P_FloorMaps", "");
                const zoneNames = Object.keys(zones).sort();

                if (zoneNames.length == 1)
                {
                    const zoneName = zoneNames[0];
                    return {
                        title: `${nameTrimmed} - ${zoneName}`,
                        onClick: () => { loadMap(packageName, zoneName); }
                    };
                }
                else
                {
                    const zoneItems = zoneNames.map((zoneName) => ({
                        title: zoneName,
                        onClick: () => { loadMap(packageName, zoneName); }
                    }));

                    return { title: nameTrimmed, menuItems: zoneItems };
                }
            });

            menu = new BurgerMenuControl({
                title: "main",
                menuItems: menuItems
            });
            menu.addTo(map);
        </script>
    </head>
    <body>
        <div id="map"></div>
    </body>
</html>